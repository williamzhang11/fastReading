# 第二章-大型网站架构模式

本章主要介绍了常见的网站架构“模式”，并特别指出，合理的利用模式可以在较短时间内可以开发出更好的系统，但是绝对
不可生搬硬套，而是在建立在对当前问题和需求深刻理解以及把握的基础上，进行创造与创新的使用。
不恰当的使用模式不但不能解决原来的问题，甚至可能带来比较棘手的新问题。

## 模式的定义

每个模式描述了一个在我们周围不断重复发生的问题及该问题解决方案的核心。这样，就可以一次又一次使用该方案而不必
做重复工作。

大型网站架构同样是如此，这些模式被一再印证，通过学习它们可以掌握大型网站架构的一般思路和解决方案，以直到我们的架构设计。

## 2.1 网站架构模式

问题：大型网站一般面临，高并发访问，海量数据处理，高可靠运行等一系列问题与挑战

架构目标：网站高性能，高可用，易伸缩，可扩展，安全等技术架构目标

常见的架构模式：分层，分割，分布式，集群，缓存，异步，冗余，自动化，安全等9大架构模式

## 2.1.1分层

分层是将系统在横向维度上切分成几个部分，每部分负责一部分相对比较单一的职责。通过上层对下层
的依赖和调用组成一个完整系统。

通常将网站软件系统分为应用层，服务层，数据层。

	应用层：负责具体业务和视图展示，如网站首页和搜索输入和结果展示
	服务层：为应用层提供服务支持，如用户管理服务，购物车服务
	数据层：提供数据存储访问服务，如数据库，缓存，文件，搜索引擎
	
作用:
	1.通过分层可以将一个庞大的软件系统切分为不同部分，便于分工合作和维护。
	2.各层之间保持一定独立性。
	3.只要调用接口不变，各层可根据具体问题独立演化发展。
	4.三层可部署在同一台机器上，也可以分开部署，使网站有用更多的计算资源以应对更多的用户访问。
	5.各分层内部可继续分层，如应用层可细分为视图层，业务逻辑处理层。服务层可细分为数据接口层（以适配
	各种输入和输出的数据格式）和逻辑处理层。
	
原则：
	1.分层架构必须合理规划层次边界和接口
	2.禁止跨层次的调用（应用层直接调用数据层）及逆向调用
	
## 2.1.2分割

分割是纵向方向对软件进行分割，将不同功能和服务分割开来，包装成高内聚低耦合的模块单元。

作用：1.有助于软件开发和维护。2.便于分布式部署，提供网站并发处理能力和功能扩展能力。

大型网站分割的粒度可能很小，如在应用层，将不同业务进行分割，如购物，论坛，搜索，广告分割成不同应用，由独立团队负责，部署
在不同服务器上。

在同一个应用内部，如果规模庞大，业务复杂，将继续分割，如购物业务，可进一步分割成机票酒店业务，3C业务，小商品业务。

即使在这个粒度上还可以继续分割成首页，搜索列表，商品详情等模块。

## 2.1.3分布式

分层和分割的目的是为了便于分布式部署，通过远程调用协同工作。这样获取的计算资源包括CPU,内存，存储资源也越多，能够
处理的并发访问和数据量也越大。

问题：

	1.分布式服务之间的调用依赖网络
	2.服务器越多，宕机的概率越大，一台服务造成不可用可能引起雪崩效应，造成很多服务不可用
	3.数据一致性难保证
	4.分布式事务难保证
	5.对业务的正确性以及业务流程造成很大影响。
	6.导致网站依赖错综复杂，开发管理维护困难

常见分布式方案：

	1.分布式应用和服务：
		1.将分层和分割后的应用和服务模块分布式部署后，除了可以改善网站性能和并发性
		加快开发和发布 速度，减少数据库连接资源消耗外。
		2.可以使不同应用复用共同服务，便于业务扩展。
		
	2.分布式静态资源
	动静分离。将静态资源独立分布式部署，采用独立域名。静态资源分布式部署可减轻应用服务器负载压力。负责用户体验的团队
	进行开发维护有利于网站分工合作
	
	3.分布式数据和存储
	大型网站需要以p为单位的海量数据，单台机器无法提供如此大的存储空间，需要分布式存储。除了对
	传统关系数据库进行分布式部署外，Nosql数据库基本都是分布式的
	
	4.分布式计算
	应用，服务，实时数据处理都是计算，除了要处理这些在线业务还包括，搜索引擎的引擎的索引创建，数据仓库的数据
	分析统计。	使用Hadoop和MapReduce分布式计算框架进行批处理，特点是移动计算而不是移动数据，将计算程序
	分发到数据所在位置以加速计算和分布式计算。
	
	5.分布式配置
	支持网站线上服务器配置实时更新
	
	6.分布式锁
	支持分布式环境下，实现并发和协同
	
	7.分布式文件系统
	支持云存储
	
## 2.1.4 集群

使用分布式可将分层和分割后的模块独立部署，但对于用户集中访问模块，还需要独立部署服务器集群化。

	优点：
	1.更好的并发性。当有更多的用户访问时，只需要向集群加入新机器。
	2.故障转移，提高可用性。当某台服务器发生故障时，负载均衡设备或系统的失效转移会将请求转发到集群其他机器上

## 2.1.5 缓存

使用 缓存条件：

	1.数据访问热点不均衡，某些数据会被更频繁的访问，这些数据应该放在缓存中
	2.数据在某个时间段内有效，不会很快过期，否则在产生脏读。
	
作用：

	1.加快访问速度，
	2.减轻后端应用和数据存储负载压力
	
种类：

	1.CDN:部署在距离终端用户最近的网络服务商，可以就近以最快速度返回用户.
	
	2.反向代理:部署在网站前端,用户请求达到网站的数据中心时,最先访问到反向代理服务器,缓存的
	静态资源无需转发请求,就能返回给用户.
	
	3.本地缓存:应用服务本地缓存热点数据,可以在本机内存中直接访问数据,而无需访问数据库
	
	4.分布式缓存:本地缓存的内存是总是有限的,因此需要分布式缓存,将热点数据放到缓存集群中,应用通过网络访问
	
## 2.1.6 异步

降低软件耦合性,事物之间的直接关系就越少,越少的被彼此影响,越可以独立发展.

手段:分层,分割,分布,异步等

异步:业务之间消息传递不是同步调用,而是将一个业务操作分为多个阶段,每个阶段之间通过共享数据方式异步执行.

单服务器内部可通过多线程共享内存队列方式实现异步,处在业务操作前面的线程写入队列,后面线程从队列中读取数据进行处理

分布式系统中,多个服务器集群通过分布式消息队列实现异步,分布式消息队列可以看作内存队列的分布式部署.

异步架构是典型的生产者消费者模式,2者不直接调用.

优点:

	1.容易扩展
	2.提高系统可用性:消费者服务器发送故障,数据会在消息队列服务器存储堆积,生产者服务器可继续处理业务请求.
	系统整理表现无故障,恢复正常后,继续处理队列中数据
	3.加快网站响应速度:不需要等待消费者服务器处理就可以返回,响应延迟
	4.消除并发访问高峰:网站访问存在高峰和低谷,即使按照高峰进行规划和部署,也会出现突发事件,如
	购物网站促销,微博的热点事件,会造成访问量突然增大,造成整个网站负载过重,响应延迟,严重时出现宕机.
	使用消息队列可以将突然增加的访问请求数据放入消息队列中,等待消费者依次处理.
	
缺点:
	1.可能对用户体验,业务流程造成影响,需要网站产品设计方面的支持
	
	
## 2.1.7 冗余

服务器规模比较大时,出现某台服务器宕机是必然事件.因此为了保证服务器在宕机时网站依然可以继续服务
不丢失数据,就需要一定程度的服务器冗余运行,数据冗余备份.这样当某台服务器宕机时,可以将其上的服务和数据
访问转移到其他机器上.

服务: 即使访问和负载很小的服务也必须部署至少两台服务器构成一个集群.

数据库备份:分为冷备份,热备份

	冷备份包括,定期备份,存档保存.
	热备份:主从分离,半同步(异步)复制.
	灾备数据中心:网站程序和数据实时同步到多个灾备数据中心
	
## 2.1.8 自动化

在无人值守的情况下网站可以正常运行,一切都可以自动化时理想状态,目前大型网站的自动化框架架构设计只要集中在发布运维.

作用:减少人为干预,使发布过程自动化,减少人为干预,进而减少故障.

自动发布过程包括:

	自动化代码管理:代码版本控制,代码分支创建合并等自动化,开发工程师只需要提交自己参与产品代号,系统自动自动为
	其创建开发分支,后期代码自动合并
	
	自动化测试:提交测试后,系统自动将代码部署到测试环境,启动自动化测试用力进行测试,然后发送测试报告
	
	自动化安全检测:安全检测工具通过对代码进行静态安全扫描以及部署安全测试环境进行安全攻击测试,评估其安全性
	
	自动化部署:自动部署到生成环境
	
自动化监控过程包括:

网站运行时,可能出现各种问题,如服务器宕机,程序bug,存储空间不足,突然包发的访问高峰.

	自动化监控:对服务器心跳检测,并监控其各项性能指标和应用程序的关键数据指标.如果发现异常,超出预设阈值,就自动化报警.
	
	自动化报警:向相关人员发送报警信息.
	
	自动化失效转移:将失效的服务器从集群中隔离出去,不再处理系统应用请求.待故障消除后,系统进行自动化恢复
				重启服务保证,同步数据保证数据一致性.
	
	自动化降级:在网站遇到访问高峰,超出网站最大处理能力时,为了保证整个网站的安全可用,会自动降级,通过拒绝
			部分请求及关闭部分不重要服务将系统负载降低到一个安全水平
			
	自动化分配资源:将空闲资源分配给重要服务,扩大其部署规模.
	
## 2.1.9 安全

安全架构模式:

	1.密码+手机校验码
	2.登录,交易操作对网络加密
	3.存储的敏感数据进行加密
	4.对常见的XSS攻击,SQL注入,进行编码转换等相应处理
	5.对垃圾信息,敏感信息进行过滤
	6.对交易转账等重要操作根据交易模式和交易信息进行风险控制

# 2.2新浪微博的架构模式

和大多数网站一样,新浪微博也是从一个小网站发展起来的.随着用户的增加系统不堪重负,几经重构,形成现在的架构.

![image](https://github.com/williamzhang11/fastReading/blob/master/src/main/java/com/xiu/fastReading/corePrinciple/image/2.2.jpg)
	

系统分为3层:

	最下层基础服务层:提供数据库,缓存,存储,搜索等数据服务,以及其他基础技术服务,这些服务是微博海量数据,和高并发访问
	的技术基础.
	
	中间层:平台服务和应用服务,微博核心服务是微博,关系和用户,是业务的支柱,这些服务被分割为独立服务模块,通过依赖调用
	和共享基础数据构成新浪微博的业务基础.
	
	最上层是API和微博业务层,各种客户端(包括web)和第三方应用通过API集成到新浪微博系统中,共同构成一个生态系统.
	
上述被分层和分割后的业务模块和基础技术模块分布式部署,每个模块都部署在一组独立的服务器集群上,通过远程调用依赖访问.

现在常见的是将物理机虚拟成多个虚拟机后,部署应用.

微博发布后,
 










	
	
	











